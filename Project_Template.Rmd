---
title: "What Drives Energy and Environment Investment? A 2021-2024 Analytic Perspective"
author: "E. Yang, Y. Ma, J. Pyo, M. Finch"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: true
  toc_depth: 3

editor_options:
  chunk_output_type: console

---

\listoftables 
\listoffigures 

<body style="background-color:lightblue;">

*Github*: https://github.com/esthermy63/FinchMaPyoYang_ENV872_EDA_FinalProject.git

```{r setup, include=FALSE}
# Set your working directory
# Load packages
getwd()
library(tidyverse)
library(sf)
library(ggplot2)
library(dplyr)
library(mapview)
library(leaflet)
library("GGally")
library(readxl)
library(RColorBrewer)
library(knitr)

# Set theme
mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")
theme_set(mytheme)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
#Federal Energy and Environment investment data by state 
Investment_state <- read.csv("Data/Raw/Federal energy and environment spending by STATE (2010-2025).csv", stringsAsFactors = T)

#Natural disaster data
disasters <- read.csv("Data/Raw/DisasterDeclarationsSummaries.csv", stringsAsFactors = T)

#spatial data
states <- st_read("Data/Spatial/cb_2018_us_state_20m.shp", stringsAsFactors = T)

# Read in census data
census_2021 <- read.csv("Data/Raw/Census/ACSSPP1Y2021.S0201-2025-11-29T154845.csv", stringsAsFactors = T)
census_2022 <- read.csv("Data/Raw/Census/ACSSPP1Y2022.S0201-2025-11-29T154817.csv", stringsAsFactors = T)
census_2023 <- read.csv("Data/Raw/Census/ACSSPP1Y2023.S0201-2025-11-29T154759.csv", stringsAsFactors = T)
census_2024 <- read.csv("Data/Raw/Census/ACSSPP1Y2024.S0201-2025-11-29T154742.csv", stringsAsFactors = T)

#Regulate dataset
Regulate <- read_excel("Data/Raw/Regulate_percentage(2021~2024).xlsx")
```

```{r warning=FALSE, include=FALSE}
#Data Wrangling (for 2021)
##Clean the data

#census_2021.columns = census_2021.columns.str.replace(' ','')
census2021 <- as.data.frame(t(census_2021))
colnames(census2021) <-c(census2021[1,])

census2021clean <- census2021[-1,]
#census2021clean <- census2021[-c(seq(2,length(census2021),2)),]

colnames(census2021clean) <- str_trim(colnames(census2021clean))

rownames(census2021clean) <- str_sub(rownames(census2021clean), end =-29)
#rownames(census2021clean) <- gsub("."," ", rownames(census2021clean))

census2021clean <- census2021clean %>% 
  select("Total population", "Male", "Female", "Under 5 years", "5 to 17 years", "Median age (years)", "Median household income (dollars)","Gas", "Electricity","All other fuels","No fuel used") %>% 
  mutate(year = 2021, State = rownames(census2021clean))
  #mutate(State = sub("."," ", State)) # Remove the dots in State names
census2021clean$State <- gsub( "\\."," ",census2021clean$State)

census2021clean$`Total population` <- as.numeric(str_trim(census2021clean$`Total population`))
census2021clean$`Male` <- as.numeric(str_trim(census2021clean$`Male`))
census2021clean$Female <- as.numeric(str_trim(census2021clean$`Female`))
census2021clean$`Under 5 years` <- as.numeric(str_trim(census2021clean$`Under 5 years`))
census2021clean$`5 to 17 years` <- as.numeric(str_trim(census2021clean$`5 to 17 years`))
census2021clean$`Median age (years)` <- as.numeric(str_trim(census2021clean$`Median age (years)`))
census2021clean$`Median household income (dollars)` <- as.numeric(str_trim(census2021clean$`Median household income (dollars)`))

census2021clean$Gas <- as.numeric(str_trim(census2021clean$Gas))
census2021clean$Electricity <- as.numeric(str_trim(census2021clean$Electricity))
census2021clean$`All other fuels` <- as.numeric(str_trim(census2021clean$`All other fuels`))
census2021clean$`No fuel used` <- as.numeric(str_trim(census2021clean$`No fuel used`))


#add column for children ages 0-17 

census2021clean <- census2021clean%>%
  mutate(child=`Under 5 years` + `5 to 17 years`)


## Energy dataset (State Level)
  
Investment_state_2021 <- Investment_state %>% 
  select("STATEFP","stname", "stusps","TotalFedAction_EnergyEnv_2021","TotalFedAction_2021")
Investment_state_2021$TotalFedAction_EnergyEnv_2021 <- 
gsub("\\$ ", "", Investment_state_2021$TotalFedAction_EnergyEnv_2021)
Investment_state_2021$TotalFedAction_2021 <- 
gsub("\\$ ", "", Investment_state_2021$TotalFedAction_2021)
Investment_state_2021 <- Investment_state_2021 %>% 
  mutate(TotalFedAction_EnergyEnv_2021 =
           as.numeric(
             gsub(",", "", trimws(TotalFedAction_EnergyEnv_2021)))
         ) %>% 
  mutate(TotalFedAction_2021 =
           as.numeric(
             gsub(",", "", trimws(TotalFedAction_2021)))
         ) %>% 
  mutate(Ratio = TotalFedAction_EnergyEnv_2021/TotalFedAction_2021,
         Year = 2021)


#Disaster
states_names <- data.frame(abbrev = states$STUSPS,
                           State = states$NAME) 
#The disaster data set has only abbreviation for states, so full names need to be joined from other dataset.

#summarize disaster count by state
disaster2021 <- disasters %>% 
  filter(fyDeclared %in% c(2021)) %>% 
  arrange(state) %>% 
  group_by(state, fipsStateCode) %>% 
  summarise(Disasters = n())

disaster2021 <- left_join(disaster2021, states_names, by = c("state" = "abbrev"))

#Public awareness
Regulate2021 <- Regulate %>% 
  select("GeoName","2021")


#Combining all the variables (Demographic, disaster and public awareness)
combined2021 <- left_join(census2021clean, Investment_state_2021, by = c("State" = "stname"))

combined2021 <- left_join(combined2021, disaster2021, by = c("State" = "State"))

combined2021 <- left_join(combined2021, Regulate2021, by = c("State" = "GeoName"))



write.csv(combined2021, file = "Data/Processed/combined2021.csv")
```

```{r warning=FALSE, include=FALSE}
#Data Wrangling (for 2022)
##Clean the data

census2022 <- as.data.frame(t(census_2022))
colnames(census2022) <- c(census2022[1,])

census2022clean <- census2022[-1,]

colnames(census2022clean) <- str_trim(colnames(census2022clean))
rownames(census2022clean) <- str_sub(rownames(census2022clean), end = -29)
census2022clean <- census2022clean[seq(1, nrow(census2022clean), by = 2),]

census2022clean <- census2022clean %>% 
  select("Total population", "Male", "Female", "Under 5 years", "5 to 17 years",
         "Median age (years)", "Median household income (dollars)",
         "Gas", "Electricity", "All other fuels", "No fuel used") %>% 
  mutate(year = 2022, State = rownames(census2022clean))

census2022clean$State <- gsub("\\.", " ", census2022clean$State)

# Numeric conversions
cols_to_num <- c("Total population","Male","Female","Under 5 years","5 to 17 years",
                 "Median age (years)","Median household income (dollars)",
                 "Gas","Electricity","All other fuels","No fuel used")

census2022clean[cols_to_num] <- lapply(census2022clean[cols_to_num],
                                       function(x) as.numeric(str_trim(x)))

# Child column
census2022clean <- census2022clean %>%
  mutate(child = `Under 5 years` + `5 to 17 years`)


## Energy dataset (State Level)
Investment_state_2022 <- Investment_state %>% 
  select("STATEFP","stname","stusps",
         "TotalFedAction_EnergyEnv_2022","TotalFedAction_2022")

Investment_state_2022$TotalFedAction_EnergyEnv_2022 <- 
  gsub("\\$ ", "", Investment_state_2022$TotalFedAction_EnergyEnv_2022)

Investment_state_2022$TotalFedAction_2022 <- 
  gsub("\\$ ", "", Investment_state_2022$TotalFedAction_2022)

Investment_state_2022 <- Investment_state_2022 %>% 
  mutate(TotalFedAction_EnergyEnv_2022 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_EnergyEnv_2022)))) %>% 
  mutate(TotalFedAction_2022 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_2022)))) %>% 
  mutate(Ratio = TotalFedAction_EnergyEnv_2022 / TotalFedAction_2022,
         Year = 2022)


#Disaster
states_names <- data.frame(abbrev = states$STUSPS,
                           State = states$NAME)

disaster2022 <- disasters %>% 
  filter(fyDeclared %in% c(2022)) %>% 
  arrange(state) %>% 
  group_by(state, fipsStateCode) %>% 
  summarise(Disasters = n())

disaster2022 <- left_join(disaster2022, states_names, by = c("state" = "abbrev"))

#Public awareness
Regulate2022 <- Regulate %>% 
  select("GeoName","2022")


#Combined dataset
combined2022 <- left_join(census2022clean, Investment_state_2022,
                          by = c("State" = "stname"))

combined2022 <- left_join(combined2022, disaster2022,
                          by = c("State" = "State"))

combined2022 <- left_join(combined2022, Regulate2022,
                          by = c("State" = "GeoName"))

write.csv(combined2022, file = "Data/Processed/combined2022.csv")

```

```{r warning=FALSE, include=FALSE}
# Data Wrangling (for 2023)
## Clean the data

census2023 <- as.data.frame(t(census_2023))
colnames(census2023) <- c(census2023[1,])
census2023clean <- census2023[-1,]

colnames(census2023clean) <- str_trim(colnames(census2023clean))
rownames(census2023clean) <- str_sub(rownames(census2023clean), end = -29)
census2023clean <- census2023clean[seq(1, nrow(census2023clean), by = 2),]

census2023clean <- census2023clean %>% 
  select("Total population", "Male", "Female", "Under 5 years", "5 to 17 years",
         "Median age (years)", "Median household income (dollars)",
         "Gas", "Electricity", "All other fuels", "No fuel used") %>% 
  mutate(year = 2023, State = rownames(census2023clean))

census2023clean$State <- gsub("\\.", " ", census2023clean$State)

# Numeric conversions
cols_to_num <- c("Total population","Male","Female","Under 5 years","5 to 17 years",
                 "Median age (years)","Median household income (dollars)",
                 "Gas","Electricity","All other fuels","No fuel used")

census2023clean[cols_to_num] <- lapply(census2023clean[cols_to_num],
                                       function(x) as.numeric(str_trim(x)))

# Child column
census2023clean <- census2023clean %>%
  mutate(child = `Under 5 years` + `5 to 17 years`)


## Energy dataset (State Level)
Investment_state_2023 <- Investment_state %>% 
  select("STATEFP","stname","stusps",
         "TotalFedAction_EnergyEnv_2023","TotalFedAction_2023")

Investment_state_2023$TotalFedAction_EnergyEnv_2023 <- 
  gsub("\\$ ", "", Investment_state_2023$TotalFedAction_EnergyEnv_2023)
Investment_state_2023$TotalFedAction_2023 <- 
  gsub("\\$ ", "", Investment_state_2023$TotalFedAction_2023)

Investment_state_2023 <- Investment_state_2023 %>% 
  mutate(TotalFedAction_EnergyEnv_2023 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_EnergyEnv_2023)))) %>% 
  mutate(TotalFedAction_2023 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_2023)))) %>% 
  mutate(Ratio = TotalFedAction_EnergyEnv_2023 / TotalFedAction_2023,
         Year = 2023)


# Disaster
states_names <- data.frame(abbrev = states$STUSPS,
                           State = states$NAME)

disaster2023 <- disasters %>% 
  filter(fyDeclared %in% c(2023)) %>% 
  arrange(state) %>% 
  group_by(state, fipsStateCode) %>% 
  summarise(Disasters = n())

disaster2023 <- left_join(disaster2023, states_names, by = c("state" = "abbrev"))

# Public awareness
Regulate2023 <- Regulate %>% 
  select("GeoName","2023")


# Combined dataset
combined2023 <- left_join(census2023clean, Investment_state_2023,
                          by = c("State" = "stname"))

combined2023 <- left_join(combined2023, disaster2023,
                          by = c("State" = "State"))

combined2023 <- left_join(combined2023, Regulate2023,
                          by = c("State" = "GeoName"))

write.csv(combined2023, file = "Data/Processed/combined2023.csv")

```

```{r warning=FALSE, include=FALSE}
# Data Wrangling (for 2024)
## Clean the data

census2024 <- as.data.frame(t(census_2024))
colnames(census2024) <- c(census2024[1,])
census2024clean <- census2024[-1,]

colnames(census2024clean) <- str_trim(colnames(census2024clean))
rownames(census2024clean) <- str_sub(rownames(census2024clean), end = -29)
census2024clean <- census2024clean[seq(1, nrow(census2024clean), by = 2),]

census2024clean <- census2024clean %>% 
  select("Total population", "Male", "Female", "Under 5 years", "5 to 17 years",
         "Median age (years)", "Median household income (dollars)",
         "Gas", "Electricity", "All other fuels", "No fuel used") %>% 
  mutate(year = 2024, State = rownames(census2024clean))

census2024clean$State <- gsub("\\.", " ", census2024clean$State)

# Numeric conversions
cols_to_num <- c("Total population","Male","Female","Under 5 years","5 to 17 years",
                 "Median age (years)","Median household income (dollars)",
                 "Gas","Electricity","All other fuels","No fuel used")

census2024clean[cols_to_num] <- lapply(census2024clean[cols_to_num],
                                       function(x) as.numeric(str_trim(x)))

# Child column
census2024clean <- census2024clean %>%
  mutate(child = `Under 5 years` + `5 to 17 years`)


## Energy dataset (State Level)
Investment_state_2024 <- Investment_state %>% 
  select("STATEFP","stname","stusps",
         "TotalFedAction_EnergyEnv_2024","TotalFedAction_2024")

Investment_state_2024$TotalFedAction_EnergyEnv_2024 <- 
  gsub("\\$ ", "", Investment_state_2024$TotalFedAction_EnergyEnv_2024)
Investment_state_2024$TotalFedAction_2024 <- 
  gsub("\\$ ", "", Investment_state_2024$TotalFedAction_2024)

Investment_state_2024 <- Investment_state_2024 %>% 
  mutate(TotalFedAction_EnergyEnv_2024 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_EnergyEnv_2024)))) %>% 
  mutate(TotalFedAction_2024 =
           as.numeric(gsub(",", "", trimws(TotalFedAction_2024)))) %>% 
  mutate(Ratio = TotalFedAction_EnergyEnv_2024 / TotalFedAction_2024,
         Year = 2024)


# Disaster
states_names <- data.frame(abbrev = states$STUSPS,
                           State = states$NAME)

disaster2024 <- disasters %>% 
  filter(fyDeclared %in% c(2024)) %>% 
  arrange(state) %>% 
  group_by(state, fipsStateCode) %>% 
  summarise(Disasters = n())

disaster2024 <- left_join(disaster2024, states_names, by = c("state" = "abbrev"))

# Public awareness
Regulate2024 <- Regulate %>% 
  select("GeoName","2024")


# Combined dataset
combined2024 <- left_join(census2024clean, Investment_state_2024,
                          by = c("State" = "stname"))

combined2024 <- left_join(combined2024, disaster2024,
                          by = c("State" = "State"))

combined2024 <- left_join(combined2024, Regulate2024,
                          by = c("State" = "GeoName"))

write.csv(combined2024, file = "Data/Processed/combined2024.csv")

```

```{r include=FALSE}
#Combine the four years
#2021
df_2021 <- combined2021 %>%
  rename(
    Total_EE_Investment = TotalFedAction_EnergyEnv_2021, 
    Political_Score = `2021`                            
  ) %>%
  mutate(Year = 2021) %>% 
  select(State, Year, Total_EE_Investment, Political_Score, Disasters, 
         `Total population`, Female, child, `Median age (years)`, 
         `Median household income (dollars)`, Gas, Electricity) 
      

# 2022
df_2022 <- combined2022 %>%
  rename(
    Total_EE_Investment = TotalFedAction_EnergyEnv_2022,
    Political_Score = `2022`
  ) %>%
  mutate(Year = 2022) %>% 
  select(State, Year, Total_EE_Investment, Political_Score, Disasters, 
         `Total population`, Female, child, `Median age (years)`, 
         `Median household income (dollars)`, Gas, Electricity)

# 2023
df_2023 <- combined2023 %>%
  rename(
    Total_EE_Investment = TotalFedAction_EnergyEnv_2023,
    Political_Score = `2023`
  ) %>%
  mutate(Year = 2023) %>% 
  select(State, Year, Total_EE_Investment, Political_Score, Disasters, 
         `Total population`, Female, child, `Median age (years)`, 
         `Median household income (dollars)`, Gas, Electricity)

# 2024
df_2024 <- combined2024 %>%
  rename(
    Total_EE_Investment = TotalFedAction_EnergyEnv_2024,
    Political_Score = `2024`
  ) %>%
  mutate(Year = 2024) %>% 
  select(State, Year, Total_EE_Investment, Political_Score, Disasters, 
         `Total population`, Female, child, `Median age (years)`, 
         `Median household income (dollars)`, Gas, Electricity)

#Merge data
final_data <- bind_rows(df_2021, df_2022, df_2023, df_2024)
write.csv(final_data, file = "Data/Processed/final_data.csv")
```

## Rationale and Research Questions
As the threats of climate change continue to grow, green investment becomes increasingly important to mitigate its effects. Our team is interested in the factors driving federal investments in the energy and environmental sectors and whether it has changed over time. To analyze this question, we are using a dataset from the Federal Energy and Environment Investment Project to look at patterns in federal grant and loan spending from 2021 to 2024.  

We hypothesized that the frequency of natural disasters might draw more attention to investment into the energy and environmental sectors. Voter concern about climate change may also attract more federal investment. 

1. How does federal energy and environment investment change from 2021 to 2024?

2. What factors affect total federal energy and environment spending? 

3. Where is federal energy and environment spending being invested (i.e. where does the money go)?

Data sets used for the study are listed as follow: 

Detail | Description
------------- | -------------
Data Source  | Portland State University - THE FEDERAL ENERGY AND ENVIRONMENT INVESTMENT PROJECT
Retrieved from  | https://www.pdx.edu/policy-consensus-center/federal-energy-environment-investment-project 
Variables Used  | State, All federal grants for a state in FY 2021 to 2024, Federal grants of energy and investment for a state in FY 2021 to 2024
Date Range  | 2021-2024

Detail | Description
------------- | -------------
Data Source  | United States Census Bureau
Retrieved from  | https://www.census.gov/data/tables/time-series/demo/popest/2020s-state-total.html
Variables Used  | Total population, Male, Female, Median age, Median household income, Gas, Electricity, All other fuels, No fuel used, Year, State, Child (age 0-17)
Date Range  | 2021-2024

Detail | Description
------------- | -------------
Data Source  | OpenFEMA Dataset: Disaster Declarations Summaries - v2
Retrieved from  | https://www.fema.gov/openfema-data-page/disaster-declarations-summaries-v2
Variables Used  | State, Disaster Number
Date Range  | 2021-2024

Detail | Description
------------- | -------------
Data Source  | Yale Program on Climate Change Communication
Retrieved from  | https://climatecommunication.yale.edu/visualizations-data/ycom-us/
Variables Used  | State, Estimated % of adults who are somewhat or very worried about global warming
Date Range  | 2021-2024

Detail | Description
------------- | -------------
Data Source  | United States Census Bureau
Retrieved from  | https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip
Variables Used  | State, Geometry
Date Range  | 2018
\newpage

## Dataset Information
We selected 10 variables of interest from different data sources, from demographic characteristics, disaster frequency, and percentage of public awareness of climate change.
Each annual dataset was processed and summarized in R. For every year, the resulting dataset contains 51 observations (one row per state, plus D.C.) and 12 columns (10 variables, state name and year).

Below is an example summary output for the 2021 dataset, and for further analysis, dataset from each year were bound by rows, producing a final dataset of 204 objects of 10 variables.
```{r echo=FALSE, warning=FALSE}
#summary(df_2021)
#summary(final_data)

summary_2021mean <- df_2021 %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Mean = ~mean(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_2021mean <- as.data.frame(t(summary_2021mean))
summary_2021SD <- df_2021 %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             SD = ~sd(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_2021SD <- as.data.frame(t(summary_2021SD))
summary_2021max <- df_2021 %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Max = ~max(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_2021max <- as.data.frame(t(summary_2021max))
summary_2021min <- df_2021 %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Min = ~min(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_2021min <- as.data.frame(t(summary_2021min))

summary_2021 <- cbind(summary_2021mean,summary_2021SD,summary_2021max,summary_2021min)
colnames(summary_2021)<- c("Mean", "Standard Deviation","Max","Min")
kable(summary_2021, caption = "Summary Table of 2021 Dataset", digits = 1)

summary_finalmean <- final_data %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Mean = ~mean(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_finalmean <- as.data.frame(t(summary_finalmean))
summary_finalSD <- final_data %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             SD = ~sd(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_finalSD <- as.data.frame(t(summary_finalSD))
summary_finalMax <- final_data %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Max = ~max(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_finalMax <- as.data.frame(t(summary_finalMax))
summary_finalMin <- final_data %>% 
  select(-Year) %>% 
  summarise(
    across(where(is.numeric),
           list(
             Min = ~min(.x, na.rm = TRUE)
           ),
    .names = "{.col}"
    )
  ) 
summary_finalMin <- as.data.frame(t(summary_finalMin))

summary_final <- cbind(summary_finalmean,summary_finalSD,summary_finalMax,summary_finalMin)
colnames(summary_final)<- c("Mean", "Standard Deviation", "Max", "Min")
kable(summary_final, caption = "Summary Table of Final Dataset", digits = 1)

```

\newpage

## Exploratory Analysis 

Prior to performing the regression analysis, we conducted an exploratory analysis by examining the distributional properties of our key variables. The Figure 1 indicates that both federal investment amounts and disaster frequencies exhibit a strong right-skewed distribution, with a few states having exceptionally high values compared to the majority. Such deviations from normality can violate the assumptions of Ordinary Least Squares (OLS) regression, potentially leading to heteroscedasticity and unreliable coefficient estimates. To solve this issue, we applied a logarithmic transformation to the investment (Total_EE_Investment), disaster (Disasters), and population (Total population) variables. This transformation stabilizes the variance and ensures the robustness of our statistical models.

```{r echo=FALSE, warning=FALSE, fig.cap="figure 1: Scatter Plot"}
#examine the normal distribution of data
cols <- c(3:12)

ggpairs(final_data, columns = cols, title = "",  
        axisLabels = "show",
        lower = list(continuous = wrap("points", size = 0.4)),
        upper = list(continuous = wrap("cor", size = 3)))+
  theme( #adjust the axis labels
    axis.text.x = element_text(size = 5),
    axis.text.y = element_text(size = 5),
    strip.text.x = element_text(size = 5),  
    strip.text.y = element_text(size = 5)
  )
```


```{r echo=FALSE, warning=FALSE}
#visualize frequency of natural disasters 2021-2024
#summarize count 
disaster_count <-disasters %>% 
  filter(fyDeclared %in% c(2021, 2022, 2023, 2024)) %>% 
  arrange(state) %>% 
  group_by(state, fipsStateCode) %>% 
  summarise(Disasters = n())

disaster_count <- left_join(disaster_count, states_names, by = c("state" = "abbrev"))

#remove territories
disaster_count_clean <-disaster_count %>% 
    filter(fipsStateCode %in% c(1:56)) 
states_clean <-states %>% 
    filter(GEOID != '72', GEOID != '02', GEOID != '15') 
#note - also removed alaska and hawaii for mapping purposes


#join disaster to spatial data
states_sf_join <- states_clean %>%  
  left_join( 
    disaster_count_clean,  
    by = c("NAME" = "State")  
    ) 

st_crs(states_sf_join) #NAD83, espg 4269

#View with mapview - count of disasters
mapview(states_sf_join,  
        zcol = 'Disasters', # colors by disaster count
        col.regions = rev(brewer.pal(11, "RdBu"))) #high count in red 

#view with ggplot 
ggplot() +  
  geom_sf(data=states_sf_join,aes(fill = Disasters),alpha=0.5) +  
  scale_fill_gradient(low="lightyellow",high="red") + #high count in red 
  labs(fill='Disasters Frequency',
       title = "Disaster Frequency from 2021-2024") +
  theme(legend.position = "right")

#Texas, Florida, and Louisiana have the highest declared disasters from 2021-2024
```


```{r echo=FALSE, warning=FALSE}
#total federal energy/env investment map 2021-2024

#select investments from 2021-2024. 
Investment_21_24 <- Investment_state %>% 
  select("STATEFP","stname","stusps",
         "TotalFedAction_EnergyEnv_2021","TotalFedAction_EnergyEnv_2022", 'TotalFedAction_EnergyEnv_2023', 'TotalFedAction_EnergyEnv_2024')

#clean table removing $,comma, and change to numeric
Investment_21_24$TotalFedAction_EnergyEnv_2021 <- 
  as.numeric(gsub("[\\$, ]", "", Investment_21_24$TotalFedAction_EnergyEnv_2021)) 
Investment_21_24$TotalFedAction_EnergyEnv_2022 <- 
  as.numeric(gsub("[\\$, ]", "", Investment_21_24$TotalFedAction_EnergyEnv_2022))
Investment_21_24$TotalFedAction_EnergyEnv_2023 <- 
  as.numeric(gsub("[\\$, ]", "", Investment_21_24$TotalFedAction_EnergyEnv_2023))
Investment_21_24$TotalFedAction_EnergyEnv_2024 <- 
  as.numeric(gsub("[\\$, ]", "", Investment_21_24$TotalFedAction_EnergyEnv_2024))

#find sum of investment across years
Investment_21_24_clean <- Investment_21_24 %>%
  mutate(TotalFedAction_EnergyEnv_2021_2024 =
      TotalFedAction_EnergyEnv_2021 +
      TotalFedAction_EnergyEnv_2022 +
      TotalFedAction_EnergyEnv_2023 +
      TotalFedAction_EnergyEnv_2024) %>% 
  select(stusps, TotalFedAction_EnergyEnv_2021_2024)

#join investment to spatial data
investment_sf_join <- states_clean %>%  
  left_join( 
    Investment_21_24_clean,  
    by = c("STUSPS" = "stusps")  
    ) 

#View with mapview - total energy investment 2021-2024
mapview(investment_sf_join,  
        zcol = 'TotalFedAction_EnergyEnv_2021_2024', # colors by spending
        col.regions = rev(brewer.pal(11, "RdBu"))) #high spending in red 

#view with ggplot 
ggplot() +  
  geom_sf(data=investment_sf_join,aes(fill = TotalFedAction_EnergyEnv_2021_2024),alpha=0.5) +  
  scale_fill_gradient(low="lightyellow",high="red") + #high count in red 
  labs(fill='Investment',
       title = "Total Federal Energy and Environment\nSpending from 2021-2024") + #line break
  theme(legend.position = "right") 

#note - removed alaska and hawaii for mapping purposes
#The highest spending is found in California, New York, and Texas

```

```{r}
#ratio of Energy investment to Total spending map 2021-2024
#select TOTAL spending from 2021-2024. 
TotalFedAction_21_24 <- Investment_state %>% 
  select("STATEFP","stname","stusps",
         "TotalFedAction_2021", "TotalFedAction_2022",
         "TotalFedAction_2023", "TotalFedAction_2024") %>% 
  mutate(across(starts_with("TotalFedAction"), 
                 ~as.numeric(gsub("[\\$, ]", "",.x))))  #clean table

#find sum of total spending across years
TotalFedAction_21_24_clean <- TotalFedAction_21_24 %>% 
  mutate(TotalFedAction_2021_2024 =
      TotalFedAction_2021 +
      TotalFedAction_2022 +
      TotalFedAction_2023 +
      TotalFedAction_2024) %>% 
  select(stusps, TotalFedAction_2021_2024)

#Join TotalFedAction_2021_2024 to spatial data
investment_sf_all <- investment_sf_join %>%
  left_join(TotalFedAction_21_24_clean, by = c("STUSPS" = "stusps"))

#calculate ratio column
investment_sf_ratio <- investment_sf_all %>% 
  mutate( 
    Ratio = TotalFedAction_EnergyEnv_2021_2024 / TotalFedAction_2021_2024)


#View with mapview - total energy investment 2021-2024
mapview(investment_sf_ratio,  
        zcol = 'Ratio', # colors by ratio of spending
        col.regions = rev(brewer.pal(11, "RdBu"))) #high spending in red 

#view with ggplot 
ggplot() +  
  geom_sf(data=investment_sf_ratio,aes(fill = Ratio),alpha=0.5) +  
  scale_fill_gradient(low="lightyellow",high="red") + #high count in red 
  labs(fill='Investment',
       title = "Ratio of Federal Spending Invested \nin Energy and Environment 2021-2024") + #line break
  theme(legend.position = "right") 

#Out of the total federal spending, the states with the highest proportion towards Energy and Env are  DC, Wyoming, South Dakota, Montana

```


\newpage

## Analysis

### Question 1: How does federal energy and environment investment change from 2021 to 2024?
```{r eval=FALSE, include=FALSE}
#time series analysis
#Investment trend analysis

Investment <- Investment_state %>%
  select(
    stname,
    "TotalFedAction_EnergyEnv_2010","TotalFedAction_2010",
    "TotalFedAction_EnergyEnv_2011","TotalFedAction_2011",
    "TotalFedAction_EnergyEnv_2012","TotalFedAction_2012",
    "TotalFedAction_EnergyEnv_2013","TotalFedAction_2013",
    "TotalFedAction_EnergyEnv_2014","TotalFedAction_2014",
    "TotalFedAction_EnergyEnv_2015","TotalFedAction_2015",
    "TotalFedAction_EnergyEnv_2016","TotalFedAction_2016",
    "TotalFedAction_EnergyEnv_2017","TotalFedAction_2017",
    "TotalFedAction_EnergyEnv_2018","TotalFedAction_2018",
    "TotalFedAction_EnergyEnv_2019","TotalFedAction_2019",
    "TotalFedAction_EnergyEnv_2020","TotalFedAction_2020",
    "TotalFedAction_EnergyEnv_2021","TotalFedAction_2021",
    "TotalFedAction_EnergyEnv_2022","TotalFedAction_2022",
    "TotalFedAction_EnergyEnv_2023","TotalFedAction_2023",
    "TotalFedAction_EnergyEnv_2024","TotalFedAction_2024"
  ) %>%
  mutate(across(contains("FedAction"), ~ as.numeric(str_replace_all(.x, "[\\$,]", ""))))

Investment_long <- Investment %>%
  pivot_longer(cols = -stname, names_to = "YearColumn", values_to = "Spending") %>%
  mutate(
    Year = as.integer(str_extract(YearColumn, "\\d{4}")),
    Metric = if_else(str_detect(YearColumn, "EnergyEnv"), "EnergyEnv", "Total"),
    State = stname
  ) %>%
  select(State, Year, Metric, Spending) %>%
  arrange(State, Year, Metric)

Investment_nat <- Investment_long %>%
  group_by(Year, Metric) %>%
  summarise(Spending = sum(Spending, na.rm = TRUE), .groups = "drop")

Investment_ts <- Investment_nat %>%
  filter(Metric == "EnergyEnv") %>%
  select(Year, Spending) %>%
  as_tsibble(index = Year)

Investment_models <- Investment_ts %>%
  model(
    arima = ARIMA(Spending),
    ets = ETS(Spending)
  )

Investment_fc <- Investment_models %>% forecast(h = 5)

Investment_fc_tbl <- as_tibble(Investment_fc)

p_ts <- ggplot(Investment_ts, aes(x = Year, y = Spending)) +
  geom_line(size = 1) + geom_point() +
  labs(x = "Year", y = "Spending", title = "National Investment (Energy & Environment)")

p_fc <- autoplot(Investment_ts, Spending) +
  autolayer(Investment_fc) +
  labs(title = "5-year Forecast — Investment (Energy & Environment)")

print(p_ts)
print(p_fc)

  
```

### Question 2: What factors affect total federal energy and environment spending? 

This section investigated the drivers of federal energy and environmental investment across U.S. states in 2021, specifically examining the roles of environmental necessity (natural disasters) and political demand (public opinion).

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Demographic Linear regression
#Some orginal data (eg. disaster) does not follow normal distribution, thus need to be log-transformed for linear regression.
log_combined2021<- combined2021%>%
  mutate(log_pop=log(`Total population`),
         log_disaster=log(Disasters),
         log_EE_investment=log(TotalFedAction_EnergyEnv_2021))

model_1 <- lm(data = log_combined2021, log_EE_investment ~ log_pop + Female + child + `Median age (years)` + `Median household income (dollars)`  + Gas + Electricity, na.action = na.exclude)
summary(model_1)
step(model_1)

model_2 <- lm(data = log_combined2021, TotalFedAction_EnergyEnv_2021 ~ log_pop + child + `Median age (years)`  + Electricity)
summary(model_2)
step(model_2)
#Among all demographic variables, Total population, electricity and median age population are significantly related to energy and environment investment
```

In model 1 & 2, preliminary demographic analysis was conducted to identify baseline socio-economic drivers. The results indicated that Total Population (log_pop) is the dominant predictor of federal investment (p < 0.001), while median household income showed no significant effect. This necessitates including population as a key control variable in subsequent hypothesis testing to avoid omitted variable bias.

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_3 <- lm(data = log_combined2021, log_EE_investment ~  log_disaster, na.action = na.exclude)
summary(model_3) #frequency of disaster is related
```

```{r}
plot1 <- ggplot(log_combined2021, aes(x=log_disaster, y = log_EE_investment))+
  geom_point()+
  geom_smooth(method = 'lm' )+
  ylab("Logarithm of Energy and Environment Investment")+
  xlab("Logarithm of the Frequency of Disasters across the US")
plot1
```

Before constructing the final integrated model, we tested our hypotheses individually to understand the baseline relationships.
In model 3, we tested whether disaster frequency alone predicts investment. The model showed a significant positive relationship (p < 0.001), initially supporting the hypothesis that funding is reactive. At first glance, this supports the "reactive funding" hypothesis. However, this model explains only a small portion of the variance $R^2 \approx 0.25), warning us that other critical factors (like population size) are missing.

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_4 <- lm(data = log_combined2021, log_EE_investment ~  `2021`, na.action = na.exclude)
summary(model_4) # Public awareness is related
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot2 <- ggplot(log_combined2021, aes(x=`2021`, y = log_EE_investment))+
  geom_point()+
  geom_smooth(method = 'lm' )+
  ylab("Logarithm of Energy and Environment Investment")+
  xlab("")
plot2
```

Similarly, Model 4 examined the relationship between public opinion on climate change and federal investment. The results indicated a significant positive correlation (p < 0.05), suggesting that states with higher climate awareness tend to attract more funding.The positive coefficient indicates that a 1% increase in the climate-conscious voting base correlates with a measurable increase in federal funds. This supports the "proactive funding" hypothesis, where investment follows the demand for climate policy.

However, these models were limited by potential confounding factors (e.g., state size) and limited sample size (single year). To address this, we constructed a Final Integrated Model using integrated year data from 2021 to 2024.

### Question 3: Where is federal energy and environment spending being invested (i.e. where does the money go)?
The Final Integrated Model is crucial because it tests both drivers simultaneously while controlling for population. As the final results show, once we control for population, the "Disaster" effect disappears, but the "Political" effect remains—proving that political will is a true independent driver, whereas disaster funding is largely a function of state scale.
```{r echo=FALSE, warning=FALSE}
#This codes are for the merged (2021-2024) file analysis we can either choose analysis seperately or use model below!
final_data <- final_data %>%
  mutate(
    log_pop = log(`Total population`),
    log_disaster = log(Disasters + 1), 
    log_EE_investment = log(Total_EE_Investment)
  )

final_model <- lm(data = final_data, 
                  log_EE_investment ~ log_disaster + Political_Score + log_pop + as.factor(Year))

summary(final_model)
```

When analyzing the full panel data (2021-2024) and controlling for population size, the influence of disaster frequency (log_disaster) became statistically insignificant (p = 0.61). This contrasts with the preliminary analysis and suggests that the previously observed correlation between disasters and investment was largely driven by state population experience more disasters and receive more funding.

However, political pressure (Political_Score) remained a significant predictor (p < 0.05) even after controlling for population. This implies that states with a higher percentage of voters concerned about climate change actively attract more federal investment, independent of their size.

Furthermore, a temporal analysis reveals a significant surge in investment in 2024 (Coef = 0.237, p < 0.001) compared to the 2021 baseline.

\newpage

## Summary and Conclusions
1. Contrary to our initial hypothesis, natural disaster frequency is not a direct driver of federal investment when state size is taken into account.
2. Political demand for climate action effectively influences the distribution of federal resources.

The allocation of federal energy and environmental funds is best described as demographically scaled but politically responsive. While the baseline funding is determined by how many people live in a state, the variations above that baseline are significantly shaped by the political will of its voters, rather than the immediate frequency of natural disasters.


\newpage

## References
<add references here if relevant, otherwise delete this section> 
